from utils.func import LoadYAML2Dict
from env.import_env import make_env
from rollout import rollout
from rl.algorithm import *
from general_train import get_general_args
import argparse
import os
parser = argparse.ArgumentParser(description='Arguments of the general launching script for MARS.')

def launch_rollout(env, method, save_id):
    args = get_general_args(env, method)

    # exploitation setting
    args.against_baseline = False
    args.test = False
    # args.render = True
    args.exploit = True

    if method == 'nash_dqn':
        postfix = 'nash_nashdqn'
    elif method == 'nash_dqn_exploiter':
        postfix = 'nash_nashdqnexploiter'
    else:
        postfix = method+'_dqn'
    folder = f'../data/model/{save_id}/{env}_{postfix}/'
    idx_list = []
    for f in os.listdir(folder):
        idx_list.append(int(f.split('_')[0]))
    idx_list.sort()
    last_idx = idx_list[-1]
    args.load_model_full_path = folder+str(last_idx)
    
    ### Create env
    env = make_env(args)
    print(env)

    ### Specify models for each agent     
    trained_model = eval(args.algorithm)(env, args)
    args.net_architecture['hidden_dim_list'] = [64, 64, 64]
    exploiter = DQN(env, args)
    trained_model.fix()

    model = MultiAgent(env, [trained_model, exploiter], args)

    ### Rollout
    rollout(env, model, save_id, args)

if __name__ == '__main__':
    parser.add_argument('--env', type=str, default=None, help='environment')
    parser.add_argument('--method', type=str, default=None, help='method name')
    parser.add_argument('--save_id', type=str, default=None, help='identification number for each run')
    parser_args = parser.parse_args()
    launch_rollout(parser_args.env, parser_args.method, parser_args.save_id)